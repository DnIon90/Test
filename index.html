<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ferma Login Test</title>
</head>
<body>
<h1>Login / Register Test</h1>

<div id="login-area">
  <div id="not-logged">
    <input id="login-username" placeholder="Username"><br><br>
    <input id="login-password" placeholder="Parolă" type="password"><br><br>
    <button id="login-btn">Loghează</button>
    <button id="show-register-btn">Înregistrează</button>
    <div id="register-area" style="display:none;margin-top:10px;">
      <input id="reg-username" placeholder="Username"><br><br>
      <input id="reg-password" placeholder="Parolă" type="password"><br><br>
      <button id="register-btn">Creează cont</button>
      <button id="cancel-register">Anulează</button>
      <div id="reg-msg"></div>
    </div>
  </div>
  <div id="logged" style="display:none;">
    <p>Logat ca <span id="me-username"></span></p>
    <button id="logout-btn">Deconectează</button>
  </div>
</div>

<script>
async function sha256(str){
  const utf8 = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', utf8);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

const STORAGE_USERS='test_users_v1';
function loadUsers(){ return JSON.parse(localStorage.getItem(STORAGE_USERS)||'{}'); }
function saveUsers(u){ localStorage.setItem(STORAGE_USERS, JSON.stringify(u)); }

const loginUsername=document.getElementById('login-username');
const loginPassword=document.getElementById('login-password');
const loginBtn=document.getElementById('login-btn');
const showRegBtn=document.getElementById('show-register-btn');
const registerArea=document.getElementById('register-area');
const regUsername=document.getElementById('reg-username');
const regPassword=document.getElementById('reg-password');
const registerBtn=document.getElementById('register-btn');
const cancelRegister=document.getElementById('cancel-register');
const regMsg=document.getElementById('reg-msg');
const notLoggedDiv=document.getElementById('not-logged');
const loggedDiv=document.getElementById('logged');
const meUsernameEl=document.getElementById('me-username');
const logoutBtn=document.getElementById('logout-btn');

let currentUser=null;

/* ===== Register UI ===== */
showRegBtn.addEventListener('click',()=>{registerArea.style.display='block';});
cancelRegister.addEventListener('click',()=>{registerArea.style.display='none'; regMsg.textContent='';});

/* ===== Register ===== */
registerBtn.addEventListener('click', async ()=>{
  const u = regUsername.value.trim();
  const p = regPassword.value;
  if(!u || !p){ regMsg.textContent='Completează toate câmpurile'; return; }
  const users = loadUsers();
  if(users[u]){ regMsg.textContent='Username deja folosit'; return; }
  const hash = await sha256(p);
  users[u] = {passHash: hash};
  saveUsers(users);
  regMsg.textContent='Cont creat! Poți să te loghezi.';
  regUsername.value=''; regPassword.value='';
  registerArea.style.display='none';
});

/* ===== Login ===== */
loginBtn.addEventListener('click', async ()=>{
  const u = loginUsername.value.trim();
  const p = loginPassword.value;
  if(!u || !p){ alert('Completează username și parolă'); return; }
  const users = loadUsers();
  if(!users[u]){ alert('Utilizator inexistent'); return; }
  const hash = await sha256(p);
  if(hash !== users[u].passHash){ alert('Parolă greșită'); return; }
  currentUser = u;
  localStorage.setItem('currentUser',currentUser);
  onLogin();
  loginUsername.value=''; loginPassword.value='';
});

/* ===== Logout ===== */
logoutBtn.addEventListener('click', ()=>{
  currentUser=null;
  localStorage.removeItem('currentUser');
  notLoggedDiv.style.display='block';
  loggedDiv.style.display='none';
});

/* ===== On Login ===== */
function onLogin(){
  notLoggedDiv.style.display='none';
  loggedDiv.style.display='block';
  meUsernameEl.textContent=currentUser;
}

/* ===== Auto-login la refresh ===== */
window.onload = ()=>{
  const savedUser = localStorage.getItem('currentUser');
  const users = loadUsers();
  if(savedUser && users[savedUser]){
    currentUser = savedUser;
    onLogin();
  }
}
</script>
</body>
</html>