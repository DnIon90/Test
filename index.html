<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferma lui Ion - Avansată</title>
<style>
body{font-family:Arial,sans-serif;background:#d0f0c0;margin:0;padding:10px;}
h1,h2,h3{color:#2e7d32;margin:5px 0;}
button,input,select{padding:5px;margin:2px;font-size:14px;border-radius:4px;}
button{background:#2e7d32;color:#fff;border:none;cursor:pointer;}
button:hover{background:#1b5e20;}
#login-area,#farm-area,#shop-area,#admin-area,#leaderboard-area{margin-bottom:20px;}
#plots{display:flex;flex-wrap:wrap;gap:5px;margin:10px 0;}
.plot{width:60px;height:60px;background:#a0522d;border-radius:5px;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;overflow:hidden;}
.plot img{width:100%;height:100%;position:absolute;top:0;left:0;transition:transform 1s;}
.plot.ready{background:#4caf50;}
#animals-list img{width:40px;height:40px;margin:2px;}
#lake{width:300px;height:100px;background:#33aaff;border-radius:5px;position:relative;overflow:hidden;}
.fish{width:30px;height:15px;position:absolute;transition:left 1s linear, top 1s linear;}
.guard{width:40px;height:40px;position:absolute;transition:left 1s linear, top 1s linear;}
.tractor{width:50px;height:50px;position:absolute;transition:left 1s linear, top 1s linear;}
table,th,td{border:1px solid #ccc;border-collapse:collapse;padding:4px;text-align:center;}
</style>
</head>
<body>

<h1>🌾 Ferma lui Ion</h1>

<div id="login-area">
  <div id="not-logged">
    <input id="login-username" placeholder="Username"><br>
    <input id="login-password" placeholder="Parolă" type="password"><br>
    <button id="login-btn">Loghează</button>
    <button id="show-register-btn">Înregistrează</button>
    <div id="register-area" style="display:none;">
      <input id="reg-username" placeholder="Username"><br>
      <input id="reg-password" placeholder="Parolă" type="password"><br>
      <select id="reg-role"><option value="user">User</option><option value="admin">Admin</option></select><br>
      <button id="register-btn">Creează cont</button>
      <button id="cancel-register">Anulează</button>
      <div id="reg-msg"></div>
    </div>
  </div>
  <div id="logged" style="display:none;">
    Logat ca <strong id="me-username"></strong> (<span id="me-role"></span>)
    <button id="logout-btn">Deconectează</button>
  </div>
</div>

<div id="farm-area" style="display:none;">
  <h2>🪴 Parcela ta de pământ</h2>
  <button id="tractor-btn">🚜 Recoltează automat</button>
  <div id="plots"></div>
  <h3>Resurse</h3>
  🌾 Grâu: <span id="grain-count">0</span><br>
  🥕 Legume: <span id="veg-count">0</span><br>
  🍎 Mere: <span id="fruit-count">0</span><br>
  🍊 Portocale: <span id="orange-count">0</span><br>
  🍋 Lămâi: <span id="lemon-count">0</span><br>
  💰 Monede: <span id="coins-count">0</span><br>

  <h3>Lac cu pești</h3>
  <div id="lake"></div>
  <h3>Animale</h3>
  <div id="animals-list"></div>
</div>

<div id="shop-area" style="display:none;">
  <h2>🛒 Magazin</h2>
  <button onclick="buyAnimal('Câine',5)">Cumpără Câine (5 monede)</button>
  <button onclick="buyAnimal('Pisică',5)">Cumpără Pisică (5 monede)</button>
  <button onclick="buyAnimal('Pește',2)">Cumpără Pește (2 monede)</button>
</div>

<div id="leaderboard-area" style="display:none;">
  <h2>🏆 Leaderboard</h2>
  <table id="leaderboard-table">
    <thead><tr><th>Loc</th><th>Username</th><th>Monede</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
// ===== SHA-256 pentru parole =====
async function sha256Hex(str){
  const buf=new TextEncoder().encode(str);
  const hash=await crypto.subtle.digest('SHA-256',buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ===== LocalStorage =====
const STORAGE_USERS='farm_users_full';
function loadUsers(){return JSON.parse(localStorage.getItem(STORAGE_USERS)||'{}');}
function saveUsers(u){localStorage.setItem(STORAGE_USERS,JSON.stringify(u));}

// ===== Elemente UI =====
const loginUsername=document.getElementById('login-username');
const loginPassword=document.getElementById('login-password');
const loginBtn=document.getElementById('login-btn');
const showRegBtn=document.getElementById('show-register-btn');
const registerArea=document.getElementById('register-area');
const regUsername=document.getElementById('reg-username');
const regPassword=document.getElementById('reg-password');
const regRole=document.getElementById('reg-role');
const registerBtn=document.getElementById('register-btn');
const cancelRegister=document.getElementById('cancel-register');
const regMsg=document.getElementById('reg-msg');
const notLoggedDiv=document.getElementById('not-logged');
const loggedDiv=document.getElementById('logged');
const meUsernameEl=document.getElementById('me-username');
const meRoleEl=document.getElementById('me-role');
const logoutBtn=document.getElementById('logout-btn');
const farmArea=document.getElementById('farm-area');
const shopArea=document.getElementById('shop-area');
const plotsDiv=document.getElementById('plots');
const grainCount=document.getElementById('grain-count');
const vegCount=document.getElementById('veg-count');
const fruitCount=document.getElementById('fruit-count');
const orangeCount=document.getElementById('orange-count');
const lemonCount=document.getElementById('lemon-count');
const coinsCount=document.getElementById('coins-count');
const leaderboardTable=document.querySelector('#leaderboard-table tbody');
const animalsListDiv=document.getElementById('animals-list');
const tractorBtn=document.getElementById('tractor-btn');

let currentUser=null;
let currentRole=null;
let userData={grain:0,veg:0,fruit:0,orange:0,lemon:0,coins:0,plots:[],animals:[],farmLevel:1};
const plantTimes={'Grâu':10,'Legume':15,'Fructe':20,'Portocale':25,'Lămâi':25};
const plantImgs={'Grâu':'https://i.imgur.com/7bM9a5K.png','Legume':'https://i.imgur.com/Hu2z0kX.png','Fructe':'https://i.imgur.com/59lX4cP.png','Portocale':'https://i.imgur.com/jj4Zqfp.png','Lămâi':'https://i.imgur.com/Dxg5h3h.png'};
const animalImgs={'Câine':'https://i.imgur.com/t1B8fZT.png','Pisică':'https://i.imgur.com/5vG8v8E.png','Pește':'https://i.imgur.com/wKxTYJX.png'};

// ===== REGISTER / LOGIN =====
showRegBtn.onclick=()=>{registerArea.style.display='block';};
cancelRegister.onclick=()=>{registerArea.style.display='none'; regMsg.textContent='';};

registerBtn.onclick=async()=>{
  const u=regUsername.value.trim(),p=regPassword.value,role=regRole.value;
  if(!u||!p){regMsg.textContent='Completează toate câmpurile'; return;}
  const users=loadUsers();
  if(users[u]){regMsg.textContent='Username deja folosit'; return;}
  const hash=await sha256Hex(p);
  const plots=Array(12).fill().map(()=>({type:null,plantedAt:null,ready:false}));
  users[u]={passHash:hash,role:role,grain:0,veg:0,fruit:0,orange:0,lemon:0,coins:5,plots:plots,animals:[],farmLevel:1};
  saveUsers(users);
  regMsg.textContent='Cont creat! Loghează-te.';
  regUsername.value=''; regPassword.value=''; registerArea.style.display='none';
};

loginBtn.onclick=async()=>{
  const u=loginUsername.value.trim(),p=loginPassword.value;
  if(!u||!p){alert('Completează username și parolă'); return;}
  const users=loadUsers();
  if(!users[u]){alert('Utilizator inexistent'); return;}
  const hash=await sha256Hex(p);
  if(hash!==users[u].passHash){alert('Parolă greșită'); return;}
  currentUser=u; currentRole=users[u].role; userData=JSON.parse(JSON.stringify(users[u]));
  onLogin();
  loginUsername.value=''; loginPassword.value='';
};

logoutBtn.onclick=()=>{currentUser=null; currentRole=null; notLoggedDiv.style.display='block'; loggedDiv.style.display='none'; farmArea.style.display='none'; shopArea.style.display='none'; leaderboardTable.innerHTML=''; saveUserData();};

// ===== FARM =====
function onLogin(){
  notLoggedDiv.style.display='none'; loggedDiv.style.display='block'; farmArea.style.display='block'; shopArea.style.display='block';
  meUsernameEl.textContent=currentUser; meRoleEl.textContent=currentRole;
  if(!userData.plots) userData.plots=Array(12).fill().map(()=>({type:null,plantedAt:null,ready:false}));
  renderFarm(); updateUI(); renderAnimals(); renderLeaderboard();
  setInterval(updateLoop,1000);
}

function renderFarm(){
  plotsDiv.innerHTML='';
  userData.plots.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='plot'; div.dataset.index=i;
    if(p.type&&!p.ready) div.classList.add('planted');
    if(p.ready) div.classList.add('ready');
    if(p.type){
      const img=document.createElement('img'); img.src=plantImgs[p.type]; img.alt=p.type;
      if(!p.ready){
        const elapsed=Math.floor((Date.now()-p.plantedAt)/1000);
        const total=plantTimes[p.type]; let scale=(elapsed/total); if(scale>1) scale=1;
        img.style.transform=`scale(${scale})`;
      } else {img.style.transform='scale(1)';}
      div.appendChild(img);
    } else {div.textContent='Pământ gol';}
    div.onclick=()=>